# 1. 资源

论文：
- From Local to Global: A Graph RAG Approach to Query-Focused Summarization
- https://arxiv.org/pdf/2404.16130

项目主页：https://aka.ms/graphrag
Github: https://github.com/microsoft/graphrag
博客： https://microsoft.github.io/graphrag/
入门指南：https://microsoft.github.io/graphrag/posts/get_started
预印本：https://www.microsoft.com/en-us/research/publication/from-local-to-global-a-graph-rag-approach-to-query-focused-summarization/

# 2. 简介

传统的RAG方法适用于局部文本检索任务，但不适用于全局性的查询聚焦摘要任务，例如“数据集中的主要主题是什么？”这类问题。为了解决这一问题，提出了一种基于图的方法GraphRAG，利用大型语言模型（Large Language Models, LLMs）构建基于图的文本索引，以支持对整个文本语料库的全局性问题的回答。Graph Retrieval-Augmented Generation旨在改进针对私有或未见过的文档集合的查询聚焦摘要（Query-Focused Summarization, QFS）任务。
Graph RAG核心思想：通过两个阶段构建图索引，首先从源文档派生出实体知识图谱，然后为所有密切相关的实体组预生成社区摘要。

# 3. 方法

Graph RAG处理流程：

使用由大型语言模型（LLM）派生的源文档文本的图索引的Graph RAG流程。这个索引涵盖了节点（例如实体）、边（例如关系）以及协变量（例如声明），这些元素已经被为数据集领域定制的LLM提示检测、提取和总结。社区检测（例如Leiden算法）被用来将图索引划分为LLM可以在索引时间和查询时间并行总结的元素组（节点、边、协变量）。对于给定的查询，“全局答案”是通过在所有报告与该查询相关性的社区摘要上进行一轮查询聚焦的摘要来产生的。

![](.02_Graph_RAG_images/处理流程.png)

- 源文档到文本块：决定输入文本的粒度，将其分割成文本块以供处理。
- 文本块到元素实例：使用LLM提示提取文本块中的实体和关系实例。
- 元素实例到元素摘要：进一步使用LLM将实例级摘要转换为图元素的描述性文本块。
- 元素摘要到图社区：使用社区检测算法将图索引分割成模块化社区。
- 图社区到社区摘要：为每个社区生成报告式摘要，这些摘要有助于理解数据集的全局结构和语义。
- 社区摘要到社区答案再到全局答案：使用社区摘要生成最终答案，通过一个多阶段过程，包括准备社区摘要、并行生成中间答案，并最终汇总成一个全局答案。

使用Leiden算法检测到的图社区，该算法应用于索引的MultiHop-RAG数据集。圆圈代表实体节点，其大小与它们的度数成比例。节点布局是通过OpenORD和Force Atlas 2完成的。节点颜色代表实体社区，显示在两个层次的层次聚类中：(a) 第0层，对应于具有最大模块化的层次划分；以及 (b) 第1层，它揭示了这些根级别社区内的内部结构。

![](.02_Graph_RAG_images/图连接关系.png)

流程

![](.02_Micorsoft_Graph_RAG_images/流程.png)

- 将输入语料库切分为一系列TextUnits，这些TextUnits作为整个过程中可分析的单元，并在我们的输出中提供细粒度的引用。
- 使用LLM从TextUnits中提取所有实体、关系和关键主张。
- 使用Leiden技术对图进行分层聚类。要查看可视化结果，请参见下图。每个圆表示一个实体（例如，人、地点或组织），其大小表示实体的程度，颜色表示其社区。
- 从底层向上生成每个社区及其成员的摘要。这有助于全面理解数据集。

在查询时，这些结构用于为LLM上下文窗口提供材料，用于回答问题。主要查询模式包括：

全局搜索，用于推理关于语料库的整体问题，利用社区摘要。

![](.02_Micorsoft_Graph_RAG_images/全局搜索.png)

本地搜索，用于推理关于特定实体的问题，展开到它们的邻居和相关概念。

![](.02_Micorsoft_Graph_RAG_images/本地搜索.png)

提示词微调：直接使用GraphRAG可能不会产生最佳结果。我们强烈建议根据我们文档中的提示词微调指南对提示进行微调。

# 4. 结果

Graph RAG效果评估：使用两个真实世界的数据集（播客文稿和新闻文章）来评估Graph RAG方法，并与naïve RAG和全局文本摘要方法进行比较。评估指标包括全面性、多样性和授权性（Empowerment）。Graph RAG在全面性和多样性方面显著优于naïve RAG基线，并且在较低的令牌成本下与源文本地全局摘要方法相比表现出有利的性能。

在两个数据集、四个指标和每次比较125个问题上的（行条件）相对于（列条件）的一对一胜率百分比（每个问题重复五次并计算平均值）。每个数据集和指标的总体胜出者以粗体显示。自我胜率没有计算，但作为参考显示为预期的50%。所有Graph RAG条件在全面性和多样性方面都优于朴素RAG。条件C1-C3在答案的全面性和多样性方面也比TS（没有图索引的全局文本摘要）略有提高。

![](.02_Graph_RAG_images/效果.png)

新闻文章数据集的示例问题，以及由Graph RAG（C2级别）和朴素RAG生成的答案，还有由大型语言模型（LLM）生成的评估。Graph RAG答案更加丰富和多样。

![](.02_Graph_RAG_images/识别结果.png)

# 5. 评估

GraphRAG 已以多种方式进行评估。主要关注点包括：1）数据集的准确表示，2）提供响应的透明度和扎实基础，3）对提示和数据语料库注入攻击的抗性，4）低幻觉率。下面按数字概述了对每个方面的评估方式。

1. 数据集的准确表示经过手动检查和针对从测试语料库的随机选择子集创建的“金标准答案”的自动测试来测试。
2. 透明度和响应的扎实基础通过自动化答案覆盖评估和对返回的基础上下文的人工检查来测试。
3. 我们使用手动和半自动技术测试用户提示注入攻击（“越狱”）和跨提示注入攻击（“数据攻击”）。
4. 通过索赔覆盖度指标、答案和来源的手动检查，以及对试图通过恶意和异常具有挑战性的数据集进行强制妄想的对抗性攻击来评估幻觉率。



# 参考

[1] 微软多部门联合推出GraphRAG项目：全面性和多样性方面显著优于原生大模型RAG，https://mp.weixin.qq.com/s/c--xUR7Q_O7yAMsaAJRiKQ
[2] 重磅 - 微软官宣正式在GitHub开源GraphRAG，https://mp.weixin.qq.com/s/h3Q0QYdF9q3E5PD_ge-k5A